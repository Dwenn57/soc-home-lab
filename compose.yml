services:

  # Note: Had red cluster / watermark error - trying to move data directory to another drive
  elasticsearch:
    image: docker-compose-elasticsearch
    environment:
      - discovery.type=single-node
      - xpack.security.enabled=true
      - xpack.security.http.ssl.enabled=false
      - xpack.security.transport.ssl.enabled=false
      - ES_JAVA_OPTS=-Xms2g -Xmx2g
      - ELASTIC_PASSWORD=xxxxx
      - xpack.security.enrollment.enabled=false

    ports:
      - "9200:9200"
    volumes:
      - /mnt/d/elastic_data:/usr/share/elasticsearch/data
      # - ./elasticsearch/esdata:/usr/share/elasticsearch/data     # persists users/roles/tokens
      # - ./elasticsearch/esconfig:/usr/share/elasticsearch/config
    container_name: elasticsearch
    networks:
      - ubuntunet


  kibana:
    image: docker-compose-kibana

    environment:
      - ELASTICSEARCH_HOSTS=http://elasticsearch:9200

      # === Choose ONE of the following authentication methods ===
      # Option 1 (recommended when no TLS): Service Account Token
      # - ELASTICSEARCH_SERVICE_ACCOUNT_TOKEN=${KIBANA_TOKEN:-}

      # Option 2: kibana_system user credentials
      - ELASTICSEARCH_USERNAME=xxxxx
      - ELASTICSEARCH_PASSWORD=xxxxx

      # Encryption key for saved objects (minimum 32 characters)
      # - xpack.encryptedSavedObjects.encryptionKey=xxxxxxxx

      # Optional: disable Fleet onboarding screen (not needed without TLS)
      # - xpack.fleet.enabled=false

    volumes:
      - ./kibana/kibana-data:/usr/share/kibana/data           # persisted keystore & data
      - ./kibana/kibana.yml:/usr/share/kibana/config/kibana.yml:ro

    ports:
      - "5601:5601"
    depends_on:
      - elasticsearch
    container_name: kibana
    networks:
      - ubuntunet


  db:
    image: mariadb:10.11
    environment:
      - MARIADB_DATABASE=xxxx
      - MARIADB_USER=xxxx
      - MARIADB_PASSWORD=xxxxx
      - MARIADB_ROOT_PASSWORD=xxxxx
    volumes:
      - db_data:/var/lib/mysql
    networks:
      - ubuntunet


  dvwa:
    image: ghcr.io/digininja/dvwa:latest
    depends_on:
      - db
    container_name: dvwa
    environment:
      - DB_SERVER=xxx
      - DB_DATABASE=xxxx
      - DB_USER=xxx
      - DB_PASSWORD=xxxx
    ports:
      - "8081:80"
    networks:
      - ubuntunet
    volumes:
      - ./dvwa/dvwa_logs:/var/log/apache2


  # Filebeat is already parsing DVWA logs â†’ Logstash probably not needed
  filebeat:
    image: docker.elastic.co/beats/filebeat:8.14.3
    container_name: filebeat
    user: root
    volumes:
      - ./filebeat/filebeat.yml:/usr/share/filebeat/filebeat.yml:ro
      - ./dvwa/dvwa_logs:/var/log/apache2:ro
    depends_on:
      - elasticsearch
    environment:
      - ELASTICSEARCH_HOSTS=http://elasticsearch:9200
      - KIBANA_HOSTS=http://kibana:5601
      - ELASTICSEARCH_USERNAME=xxxxx
      - ELASTICSEARCH_PASSWORD=xxxxx
    networks:
      - ubuntunet
    # Using -strict.perms=false because of Windows host permission issues
    command: >
      sh -c "
        filebeat -strict.perms=false -e -c /usr/share/filebeat/filebeat.yml setup &&
        exec filebeat -strict.perms=false -e -c /usr/share/filebeat/filebeat.yml
      "


  # === Lab container - useful for testing / manual commands ===
  ubuntu-lab:
    image: ubuntu:22.04
    container_name: ubuntu-lab
    network_mode: host
    tty: true
    stdin_open: true
    user: root
    command: ["/bin/bash"]
    volumes:
      - ./ubuntu-lab:/root/lab
    # Install basic network/debug tools on startup
    entrypoint: >
      sh -c "
        apt update &&
        apt install -y iputils-ping curl netcat telnet dnsutils &&
        exec bash
      "


volumes:
  db_data:
  dvwa_logs:
  # filebeat-data: {}    # not currently used


networks:
  ubuntunet:
    driver: bridge
